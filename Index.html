<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
    <head>
        <title>Eckhardt Optics Kanban Board</title>
        <link type="text/css" href="jquery-ui-1.8.20.custom.css" rel="stylesheet" />
        <link type="text/css" href="demos.css" rel="stylesheet" />
        <link type="text/css" href="menu_black.css" rel="stylesheet" />
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <script type="text/javascript" src="jquery-1.7.2.js"></script>
        <script type="text/javascript" src="jquery.ui.core.js"></script>
        <script type="text/javascript" src="jquery.ui.widget.js"></script>
        <script type="text/javascript" src="jquery.ui.mouse.js"></script>
        <script type="text/javascript" src="jquery.ui.sortable.js"></script>
        <script type="text/javascript" src="jquery.ui.button.js"></script>
        <script type="text/javascript" src="jquery.ui.draggable.js"></script>
        <script type="text/javascript" src="jquery.ui.position.js"></script>
        <script type="text/javascript" src="jquery.ui.resizable.js"></script>
        <script type="text/javascript" src="jquery.ui.dialog.js"></script>
        <script type="text/javascript" src="jquery.ui.datepicker.js"></script>
        <script type="text/javascript" src="jquery.ui.tabs.js"></script>
        <script type="text/javascript" src="mbMenu.js"></script>
        <script type="text/javascript" src="jquery.metadata.js"></script>
        <script type="text/javascript" src="jquery.hoverIntent.js"></script>
        <script type="text/javascript" src="jquery.json-2.3.js"></script>
        <script type="text/javascript" src="tablesorter/jquery.tablesorter.js"></script>
        <script type="text/javascript" src="tiny_mce/tiny_mce.js"></script>
        <script type="text/javascript" src="tablesorter/addons/pager/jquery.tablesorter.pager.js"></script>
        <link type="text/css" href="tablesorter/themes/blue/style.css" rel="stylesheet" />
        <link type="text/css" href="index.css" rel="stylesheet" />


        <script type="text/javascript">
            $(document).ready(function() {
                
                //Enables the sortable behavior that allows the reordering of the cards
                $( ".column,.tablists" ).sortable({
                    connectWith: ".column,.tablists",
                    placeholder: "ui-state-highlight",
                    forcePlaceholderSize: true,
                    tolerance: 'pointer',
                    cursorAt: { top: 15 }
                }).disableSelection();
                
                //Initially diables the sorting of tabbed items
                $(".tablists").sortable("disable");
                
                //Prevents the banners from being selctable or sortable
                $(".column, .tablists").sortable({
                    cancel:".banners, .bigBanners",
                    items: "li:not(.banners, .bigBanners)"
                });
                
                
                //Method that opens, closes, and switches the tabs appropriately
                function handleTabLists(tablist){
                    
                    if ($(tablist).is(":visible"))
                        $(tablist).hide(1000).sortable( "disable" ); 
                    else
                    {
                        $(".tablists").each(function(){
                            if ($(this).is(":visible"))
                                $(this).hide().sortable( "disable" );
                        });
                        $(tablist).show().sortable( "enable" );
                    }
                }
                
                function closeContextMenu(){
                    $.fn.removeMbMenu($.mbMenu.options.actualMenuOpener);
                }
                
                //Handles the tab buttons dynamically
                $(".toolbar .btnTab").click(function(){
                    var tab =  $(this).html();
                   
                    handleTabLists("#"+tab);
                });
                

                //Handles the add card button
                $("#btnAddCard").click(function(){
                    addCard();
                }); 
                $("#btnSearchCard").click(function(){
                    $("#dialogSearch ").dialog("open");
                });
                                
                    
                //Pulls up the edit menu whenever a card is double clicked                       
                $(".card").live( "dblclick", function () { 
                    $( "#edit-tabs" ).tabs("select", 0);
                    editCard($(this).attr("id"));
                });
                  
                
                
                //Saets up the invalids entry dialog menu
                $( "#dialogInvalid" ).dialog({
                    autoOpen: false,
                    show: "blind",
                    hide: "explode",
                    show: "blind",
                    hide: "explode",
                    
                    modal: true,
                    buttons: {
                        Cancel: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                });
                
                
                
                //Creates the edit dialog box
                $( "#dialogSearch" ).dialog({
                    autoOpen: false,
                    resizable: false,
                    height: 800,
                    width: 1400,
                    show: { effect: 'blind', complete: function() { $("#searchSummary").focus();}},
                    hide: "explode",
                    modal: true,
                    buttons: {
                        "Search": function() {
  
                            //TODO Need to find a way to submit the selected value to PHP using Bug.search
                            //Documentation: "Note that you will only be returned information about bugs that you can see. Bugs that you can't see will be entirely excluded from the results. 
                            //So, if you want to see private bugs, you will have to first log in and then call this method."
                            
                                           
                            var searchArr = [$("#searchProduct"),$("#searchBug_severity"),$("#searchSummary"),$("#searchVersion"),$("#searchBug_status"), $("#searchResolution"),$("#searchPriority")];
                            
                            //Need to covert each search parameter to an array and remove all void values to avoid problems with PHP             
                            for (var i in searchArr){
                                var id = searchArr[i].attr("id");
                                //Bug.search doesn't like 'null' values so we will simply replace them with all the possible fields(not selecting a parameter filters nothing)
                                //TODO is there a better way? Is this doing what we want?                                
                                if ($("#"+id).val() == null)
                                {
                                    var vals = []
                                    $("#"+id+" option").each(function(){
                                        vals.push($(this).val());
                                    })
                                    $("#"+id).val(vals);                                     
                                }
                                //If the value is not an array
                                if ( ! $.isArray($("#"+id).val()))
                                {                                    
                                    //Turn it into an array
                                    $("#"+id).val( [$("#"+id).val()]);
                                }
                            }
                            
                            $.ajax({
                                url: "ajax_search_bugs.php",
                                type: "POST",
                                dataType: "json",
                                data: {                                       
                                    "priority":  $("#searchPriority").val(),
                                    "product":  $("#searchProduct").val(),
                                    "severity":  $("#searchBug_severity").val(),
                                    "summary":  $("#searchSummary").val(),
                                    "version":  $("#searchVersion").val(),
                                    "resolution":  $("#searchResolution").val(),
                                    "status":  $("#searchBug_status").val()                                    
                                },
                            
                                success: function(data, status){
                                    //First thing we want to do is clear the previous results:
                                    $( "#users tbody tr" ).remove()
                                    if (data.error)
                                    {
                                        alert(data.error.message);
                                    }
                                    else if (!data.result)
                                    {
                                        alert("Something is wrong");
                                    }
                                    else 
                                    {
                                        //Search results will be printed to the screen from here
                                        //Bugzilla documentation states that Bug.search has the same return as Bug.get, maybe recycle the syntax
                                        
                                        var bug = data.result.bugs;  
                                        for (var i in bug){                                                                                    
                                            $( "#users tbody" ).append( "<tr>" +
                                                "<td><a>"+bug[i].id+"</a></td>" + 
                                                "<td>"+bug[i].product+"</td>" + 
                                                "<td>"+bug[i].version+"</td>" +
                                                "<td>"+bug[i].assigned_to+"</td>" +
                                                "<td>"+bug[i].status+"</td>" +
                                                "<td>"+bug[i].resolution+"</td>" +
                                                "<td>"+bug[i].summary+"</td>" +
                                                "</tr>" );                                           
                                        }
                                    }
                                    
                                    //Allows sortable behavior for the search results table
                                    $("#users").trigger("update");                                     
                                },
                                error: function(jqXHR, textStatus, errorThrown){
                                    alert("There was an error:" + textStatus);
                                }
                            })
                            
                        },
                        Cancel: function() {
                            $( this ).dialog( "close" );
                        }
                    },
                    
                    //Resets all the feilds to null to allow a fresh dialog window each time
                    close: function() {
                        $("#Details input, #Details textarea, #Details select").val("");
                    }
                    
                });
                
                //Creates the edit dialog box
                $( "#dialogAddEditCard" ).dialog({
                    autoOpen: false,
                    minHeight: 560,
                    minWidth: 1060,
                    height: 560,
                    width: 1060,
                    show: { effect: 'blind', complete: function() { $("#title").focus();}},
                    hide: "explode",
                    modal: true,
                    buttons: {
                        "Save Card": function() {
                            
                            //Will need to add data editing code here later
                            $( this ).dialog( "close" );
                                                                                
                        },
                        Cancel: function() {
                            $( this ).dialog( "close" );
                        }    
                    },
                    
                    //Resets all the feilds to null to allow a fresh dialog window each time
                    close: function() {
                        $("#Details input, #Details textarea, #Details select").val("");
                    }
                    
                });
                
                
                //Allows calendar plugin
                $( ".Dates" ).datepicker(); 
                
                //Sets the table to sort
                $("#users").tablesorter();
                                
                //Allows the tabs on the edit dialog
                $( "#edit-tabs" ).tabs();
     
                
                $(document).buildContextualMenu(
                {
                    menuWidth:200,
                    overflow:2,
                    menuSelector: ".menuContainer",
                    iconPath:"ico/",
                    hasImages:false,                    
                    closeOnMouseOut: true,
                    fadeInTime:200,

                    fadeOutTime:100,

                    adjustLeft:0,
                    adjustTop:0,
                    opacity:.99,
                    shadow:true,
                    onContextualMenu:function(o,e){}

                });
                
                //Populates the context menu and add card menu with the correct columns:
                $("body .tablists, body .column").each(function(){
                    var col = $(this).attr("id");
                    
                    var anc = $("<a>").html(col);
                    var option = $("<option>").html(col);
                    
                    //append the option to the context menu
                    $("#moveAllCards, #moveCardTo").append(anc);
                    
                    //append the option to the <select>
                    $("#Details #whichColumn").append(option);
                });
                
                
                //Handles the moveallCards submenu 
                $("#moveAllCards a").click( function(){
                    //Finds and saves the column that was right clicked
                    var startCol = $($.mbMenu.lastContextMenuEl).attr("id");                
                    var endCol = $(this).html();
                    
                    if (startCol != endCol)
                    {
                        //Cycles through each card in the specified column and moves them into the ending column
                     
                        $("#"+startCol+" .card").each(function(){
                        
                            var newLi = $('<li></li>').append(this);
                            $("#"+endCol).append(newLi); 
                            var cardId = $(this).attr("id");
                            updatePosition(endCol, cardId);
                        
                        });
                    
                        //Previously the moveall method moved the cards but left all of the <li>s behind. This removes those(except the first: The banner)
                        $("#"+startCol+" li:not(:first-child)").remove();
                    }
                    
                    closeContextMenu(); 
                });
                
                
                //Handles the moveCardTo submenu moveCardTo
                $("#moveCardTo a").click(  function(){
                    var card = $($.mbMenu.lastContextMenuEl).parent();
                    var newLi = $('<li></li>').append(card);
                    var column = $(this).html();
                    
                    $("#"+column).append(newLi);
                    var cardId = $($.mbMenu.lastContextMenuEl).attr("id");
                    
                    updatePosition(column, cardId);
                                       
                    closeContextMenu(); 
                });
                
                
                //Handles the edit dialog background color change based off of user selection
                $("#bug_severity").change(function () {
                    var job = $(this).val();
                    $("#bug_severity option").each(function(){
                        $("#Details").removeClass($(this).val());
                    });
                    $("#Details").addClass(job);
                });
                
                //Populates the components field based off of the selected product
                $("#product").change(function () {
                
                    var name = [$(this).val()];
                    
                    getCompsVers(name, "Details");
                
                });
                
                //Populates the components field of the search menu based off of the selected product
                //TODO If I drag to select certain values and leave the selection area the versions arent updated. Need work around(tried click, live, bind)
                //Also note that the actual .val() after ending a drag outside of the box is correct which is indicative of a failure to call getCompsVers below
                $("#searchProduct").change(function () {
                    //Grabs the selected values
                    var name = $(this).val();                
                    getCompsVers(name, "search");
                
                });
                                            
                //Updates the cards position whenever it is moved
                $( ".column, .tablists" ).sortable({
                    receive: function(event, ui) { 
                        
                        var col = $(this).attr("id");
                        updatePosition1(col);
                    }
                });
                
                
                
                //Initializes the TinyMCE Richtext editior
                tinyMCE.init({
                    // General options
                    mode : "exact",
                    elements: "comments, description",
                    theme : "advanced",
                    plugins : "pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,inlinepopups,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template",

                    // Theme options
                    theme_advanced_buttons1 : "save,newdocument,|,bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,|,styleselect,formatselect,fontselect,fontsizeselect",
                    theme_advanced_buttons2 : "cut,copy,paste,pastetext,pasteword,|,search,replace,|,bullist,numlist,|,outdent,indent,blockquote,|,undo,redo,|,link,unlink,anchor,image,cleanup,help,code,|,insertdate,inserttime,preview,|,forecolor,backcolor",
                    theme_advanced_toolbar_location : "top",
                    theme_advanced_toolbar_align : "left",
                    theme_advanced_statusbar: "bottom",
                    theme_advanced_resizing : true,

                    // Example content CSS (should be your site CSS)
                    content_css : "index.css",

                    // Drop lists for link/image/media/template dialogs
                    template_external_list_url : "js/template_list.js",
                    external_link_list_url : "js/link_list.js",
                    external_image_list_url : "js/image_list.js",
                    media_external_list_url : "js/media_list.js"

                    
                });
                

                
                
                
                //setup the dialog with the proper field values for the bug_severity dropdown
                //Evan, go ahead and do the same for other dropdowns.  You might be able to find a way to get
                //MULTIPLE fields in one ajax call;  make an array out of the names field.
                //then parse the results --> handle each field's values
                //Hint: you'll have to wrap a foreach(to handle fields) around the foreach(to handle field's values) that I wrote.
                //And then also find some way to associate their field's name with this page's select dropdowns. (id or name maybe?)
                //also, note, I put this in the document.ready so that I'd be sure that the dialog code exists before I try to modify it.
                //The Array of fields that we want to find values for
                var formFields = ["priority","bug_severity", "bug_status", "resolution"];
            
                //A single Ajax call that finds all the specified field option values                
                $.ajax({
                    url: "ajax_get_field_values.php",
                    async: false,
                    type: "POST",
                    data: {
                        "name": formFields
                    },    
                    dataType: "json",
                    
                    success: function(data, status){
                        
                      
                        if (data.error)
                        {
                            
                            alert(data.error.message+ " Data.error is false");
                        }
                        else if (!data.result)
                        {
                            alert("Something is wrong");
                        }
                        else 
                        {
                            for (var j in data.result.fields)
                            {
                                var fieldName = data.result.fields[j].name;
                                
                               
                                //remove all <option>s from the specified select
                                $("#Details select[name="+fieldName+"]").empty();
                                
                                //Priority has a context menue that needs to be populated as well
                                if (fieldName == "priority")
                                {
                                    //Populates the priority context menu as well
                                    for (var i in data.result.fields[j].values) 
                                    {    
                                        //get the value
                                        var name = data.result.fields[j].values[i].name;
                                        var value = data.result.fields[j].values[i].sortkey;
                                        //create an option element with a value and the inner html being the name
                                        var a = $("<a>").html(name).attr({"value":value}).addClass("p");

                                        //append the option to the context menu
                                        $("#setPriority").append(a);
                                    }  
                                }
                                //iterate through all the allowed values for this field
                                for (var i in data.result.fields[j].values) 
                                {    
                                    //get the value
                                    var name = data.result.fields[j].values[i].name;
                                   
                                    //create an option element with a value and the inner html being the name
                                    var option = $("<option>").val(name).html(name);

                                    //append the option to the <select>
                                    $("#Details select[name="+fieldName+"], #search select[name="+fieldName+"]").append(option);
                                }
                            }
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown){
                        alert("(Fields)There was an error:" + textStatus);
                    }
                }); 

                
                
                //An Ajax call that finds all accessible product ids. 
                //TODO: Very slow, consider revision
                $.ajax({
                    url: "ajax_get_product_list.php",
                    type: "POST",  
                    data:{},
                    dataType: "json",
                    success: function(data){
                        
                        if (data.error)
                        {
                            
                            alert(data.error.message+ " Data.error is false");
                        }
                        else if (!data.result)
                        {
                            alert("Something is wrong");
                        }
                        
                        var productIds = data.result.ids;
                        getNames(productIds);
                        
                    },
                    error: function(jqXHR, textStatus, errorThrown){
                        alert("There was an error:" + textStatus);
                    }
                });
                
                //A function that finds the name associated with each each id that is passed in. Very slow, consider revision
                function getNames(productIds){
                    $.ajax({
                        url: "ajax_get_product_props.php",
                        type: "POST",  
                        data:{"ids": productIds},
                        dataType: "json",
                        success: function(data){
                        
                            if (data.error)
                            {
                            
                                alert(data.error.message+ " Data.error is false");
                            }
                            else if (!data.result)
                            {
                                alert("Something is wrong");
                            }
                            else
                            {
                                for (var i in data.result.products)
                                {
                                    var name = data.result.products[i].name;
                                
                                    //create an option element with a value and the inner html being the name
                                    var option = $("<option>").val(name).html(name);

                                    //append the option to the <select>
                                    $("#Details select[name=product], #search select[name=product]").append(option);
                                } 
                                //Automatically populates the components and version fields based off of the first(default) product
                                var firstProduct = $("#Details select[name=product] option").first().html(); 
                                getCompsVers(null, "search");
                                getCompsVers([firstProduct], "Details");
                            }
                                
                        
                        },
                        error: function(jqXHR, textStatus, errorThrown){
                            alert("There was an error:" + textStatus);
                        }
                    });
                    
                };
                
                
           
                var bugArray = [772,1294,9003,9215,13213,5202];
                //Adds existing cards to the page  
                $.ajax({
                    url: "ajax_get_single_bug.php",
                    type: "POST",
                    data: { 
                        "bug_id": bugArray
                    },
                    dataType: "json",
                    success: function(data, status){
                        
                        if (data.error)
                        {
                            
                            alert(data.error.message+ " Data.error is false");
                        }
                        else if (!data.result)
                        {
                            alert("Something is wrong");
                        }
                        else
                        {
                            //alert(data.result.bugs[0].summary);
                            for (var i in data.result.bugs)
                            {
                                var bug = data.result.bugs[i];
                                createCard(bug.id,"DevelopmentDone", bug.component, bug.priority, bug.product, bug.severity, bug.summary, bug.version, bug.creator, bug.deadline, "Test", bug.status);
                            }
                        }
                    }
                });                             
                
                //Sets the priority of the card 
                $(".p").live("click", function(){
                    //Grabs the anchor's text
                    var prio = $(this).html();
                    var val = $(this).attr("value");
                    
                    //Finds which card was right clicked
                    var card = $.mbMenu.lastContextMenuEl;
                    //Stores the selected priority as the cards priority
                    
                    $(card).data({"priority": prio});
                    //TODO Need a way to associate the priority string with  its sortkey
                    /*$(card).data({"priokey": val});*/
                    
                    displayHandler($(card));
                    closeContextMenu(); 
                });
                
                
                /*  $.ajax({
                    url: "ajax_modify_bug.php",
                    type: "POST",
                    data: { 
                        "bug_id": 1294,
                       
                        "priority": "P3"
                        
                    },
                    dataType: "json",
                    success: function(data, status){
                
                        if (data.error)
                        {
                            alert(data.error.message);
                        }
                        else if (!data.result)
                        {
                            alert("Something is wrong");
                        }
                        else 
                        {
                            //Will eventually hold the card.data map below. Need to make the Bug.Update work first
                        }
                        
                    },
                    error: function(jqXHR, textStatus, errorThrown){
                        alert("There was an error:" + textStatus);
                    }
                }); */

                
                
            });
              
              
              
            /*--------------------End Document.Ready------------------------*/
            
        
            var componentData = null;
        
            //Retrieves all of the available components and versions for a given product. Now revised to pull down all the products and components once and then reuse the info
            function getCompsVers(name, dialogID){
                if (componentData == null)
                {
                    $.ajax({
                        //Need this to be completed before other actions occur:
                        async: false,
                        url: "ajax_get_field_values.php",
                        type: "POST",
                        data: {
                            //"ids": id,
                            "name": ["component", "version"],
                            "value_field": "product"
                            /*"visibility_field": "Sam's Widget",
                            "values": {"visibility_values": ["Sam's Widget"]}*/
                        },    
                        dataType: "json",
                    
                        success: function(data, status){
                        
                      
                            if (data.error)
                            {
                            
                                alert(data.error.message+ " Data.error is false");
                            }
                            else if (!data.result)
                            {
                                alert("Something is wrong");
                            }
                            else 
                            {   
                                componentData =  data.result.fields;
                            
                            }
                        },
                        error: function(jqXHR, textStatus, errorThrown){
                            alert("(Fields)There was an error:" + textStatus);
                        }
                    });
                }
               
                for (var j in componentData)
                { 
            
                    var fieldName = componentData[j].name;
                                
                    //remove all <option>s from the specified select
                    $("#"+dialogID+" select[name="+fieldName+"]").empty();
                                
                    //iterate through all the allowed values for this field
                    for (var k in componentData[j].values) 
                    {   
                        //get the value
                        var visval =  componentData[j].values[k].visibility_values[0];
                        //Need to check if name is null before looping through it because other wise there is nothing to loop through
                        if (name != null)
                        {                        
                            for (var l in name)
                            {    //create an option element with a value and the inner html being the name  
                                var comp = componentData[j].values[k].name;
                                var option = $("<option>").val(comp).html(comp);
                                
                                //This is a crude method of weeding out which values should be displayed based off of the product name                           
                                if (visval == name[l])
                                {                                                               
                                    //append the option to the <select>
                                    $("#"+dialogID+" select[name="+fieldName+"]").append(option);
                                }                                    
                            }         
                        } else{
                            //If name is null we will simply display all options
                            var comp = componentData[j].values[k].name;
                            var option = $("<option>").val(comp).html(comp);
                            $("#"+dialogID+" select[name="+fieldName+"]").append(option);
                        }          
                    }
                }
            };
            
            function editCard(cardId) {
                var card = $('#'+cardId);
                getCompsVers([card.data("product")], "Details");
                //Changes the edit dialog to have the correct fields for the selected card's Product. 
                // TODO: The component and version retrieval is too slow and it changes after the dialog is opened and therefore removes the proper component and version selection
                //Bugzilla solves this by allowing the product to change without component update and then upon save a new page is opened confirming the change and prompting new version and component values
                
                // TODO: Create and new dialog if the the product name is changed  
                //Populates the fields
                $("#title").val(card.data("title"));
                $("#bug_severity").val(card.data("bug_severity"));
                $("#user").val(card.data("user"));
                $("#priority").val(card.data("priority"));
                //$("#whichColumn").val(card.data("whichColumn"));
                $("#dueDate").val(card.data("dueDate"));
                $("#description").val(card.data("description"));
                $("#product").val(card.data("product"));  
                $("#version").val(card.data("version"));
                $("#component").val(card.data("component"));
                $("#bug_status").val(card.data("status"));
              
                
                //Adds edit specifc dialog properties
                $("#dialogAddEditCard").dialog( "option", "title", "Edit Card" );
                $("#edit-tabs ul li").show();
                $("label[for=whichColumn],#whichColumn").hide();
                dialogDisplay(card.data("bug_severity"));
                
                $( "#dialogAddEditCard" ).dialog( "option", "buttons", { 
                    "Save Card": function() {
                        
                        $('#'+cardId+" .cardText").html($("#title").val());
                         
                        
                        //Finds the current column of the selected card
                        var col = card.parent().parent().attr("id");
                        
                        //TODO: Will need to send this info to the PHP file with modify function                    //Severity            //Summary
                        ajaxEditBug(col, $("#component").val(), cardId, $("#priority").val(), $("#product").val(), $("#bug_severity").val(), $("#title").val(), $("#version").val(),$("#user").val(),$("#dueDate").val(), $("#description").val(), $("#bug_status").val()); 
                        displayHandler(card); 
                        $( this ).dialog( "close" );    
                    },
                    Cancel: function() {
                        $( this ).dialog( "close" );
                    }   
                });
                $( "#dialogAddEditCard" ).dialog( "option", "close",function()  {
                   
                    $("#Details input, #Details textarea, #Details select").val("");
                }
            );   
                $( "#dialogAddEditCard" ).dialog( "open" );
                
            }
            
            function addCard() {
                //Adds add card specifc dialog properties
                $("#edit-tabs ul li:not(:first-child)").hide();
                $( "#edit-tabs" ).tabs("select", 0);
                $("label[for=whichColumn],#whichColumn").show();
                $("#dialogAddEditCard").dialog( "option", "title", "Add Card" );
                dialogDisplay(null);
                getCompsVers([$("#product").val()], "Details");
                    
                $( "#dialogAddEditCard" ).dialog( "option", "buttons", { "Save Card": function() {
                        if($( "#title" ).val()=="")
                        {
                            $("#dialogInvalid").dialog("open");
                        }
                        else{                        
                            //Calls my card creation method, physically adds the card to the page with proper name and location(for now).
                            // createCard($("#whichColumn").val(), $("#title").val()); 
                            //displayHandler($("#"+));   
                            $( this ).dialog( "close" ); 
                        } 
                    },
                    Cancel: function() {
                        $( this ).dialog( "close" );
                    }   
                });
                $( "#dialogAddEditCard" ).dialog( "option", "close",function()  {
                   
                    $("#Details input, #Details textarea, #Details select").val("");
                }
            );   
                $( "#dialogAddEditCard" ).dialog( "open" );
                
            }                    
            
               
            
            
            function deleteCard(){
                //Handles the removal of the card from the page(and eventually from the database)
                $($.mbMenu.lastContextMenuEl).parent().remove();
                
                //Insert bugzilla interfacing here
                
            }
            
            function editCardContextMenu() {
                
                editCard($($.mbMenu.lastContextMenuEl).attr("id"));
            }           
            
            function addCardToCol() {
                //Finds and saves the column that was right clicked
                var startCol = $($.mbMenu.lastContextMenuEl).attr("id"); 
                
                //Presets the form to open with the correct column selected                
                $("#whichColumn").val(startCol);
                addCard();
            }
            
            function editView(index){
                $( "#edit-tabs" ).tabs("select", index);
                editCardContextMenu();
            }
            
            /*<editor-fold>*/
            function displayHandler(card) {
                //Finds the card's values    
                var cardRef = "#"+card.attr("id");
                var job = card.data("bug_severity");
                var prio = card.data("priority");
                var dueDate = card.data("dueDate");
                var date = new Date(dueDate);
                

                
                // TODO: Need to adapt to the new names
                //For simplicity the following maps will be defined until we switch to the real Bugzilla: "Blocker"=>"Bug",  "Criticial"=>"TBD", "Major"=>"Feature Request", "Normal"=> "DesignBug"
                if (job != null)
                {
                    $("#bug_severity option").each(function(){
                    
                        $(cardRef).removeClass($(this).val());
                    })
                    $(cardRef).addClass(job).attr({"title": job});
                    
                    $("#bug_severity option").each(function(){
                        $("#Details").removeClass($(this).val());
                    });
                    $("#Details").addClass(job);
                }
                if (job == null)
                {
                    $("#bug_severity option").each(function(){
                        $("#Details").removeClass($(this).val());
                    });
                    $("#Details").addClass("normal");
                    $(cardRef).addclass("normal");
                    
                }
        
                //$(cardRef).addclass("Task");
                
                //This section adds and switches the priority icon. TODO need to find new method taking the P# classification used by bugzilla
                if (prio != "Normal" && $(cardRef + " .prioBack").length == 0)
                {
                    $(cardRef+ " .iconBar").append("<div class=\"prioBack\"><div class=\"prioIcon\"></div></div>");
                }
                if (prio != "Normal")
                {
                    $("#priority option").each(function(){                    
                        $(cardRef+" .iconBar .prioBack .prioIcon").removeClass($(this).val());
                    });
                
                    $(cardRef+" .iconBar .prioBack .prioIcon").addClass(prio).attr({"title": prio + " Priority"});
                }
                else if (prio == "Normal")
                {
                    $(cardRef+" .iconBar .prioBack ").remove();
                }
                
                
                //This section handles the calendar icon
                if (dueDate != null && $(cardRef + " .iconBar .calBack").length == 0)
                {
                    $(cardRef+ " .iconBar").append("<div class=\"calBack\"><div class=\"calIcon\"></div></div>"); 
                }
                if (dueDate == null || dueDate == "")
                {
                    $(cardRef+ " .iconBar .calBack").remove(); 
                }
                var day = date.getDate();
                var month = date.getMonth(); 
                var year = date.getFullYear();
                var until = daysUntil(year, month, day);
                $(cardRef+ " .iconBar .calBack .calIcon").html(day).attr({"title": "Due: "+ dueDate + " ("+until+" days from today)"});
                if (until <= 7 && until > 0)
                {
                    $(cardRef+ " .iconBar .calBack .calIcon").addClass("calIconWeek");
                }
                else
                {
                    $(cardRef+ " .iconBar .calBack .calIcon").removeClass("calIconWeek");    
                }
                
                
                if (until <= 0)
                {
                    $(cardRef+ " .iconBar .calBack .calIcon").addClass("calIconNeg");
                    $(cardRef+ " .iconBar .calBack .calIcon").attr({"title": "Due: "+ dueDate + " ("+(-until)+" days ago)"});
                }
                else
                {
                    $(cardRef+ " .iconBar .calBack .calIcon").removeClass("calIconNeg");
                }
                if (until == 0)
                {
                    $(cardRef+ " .iconBar .calBack .calIcon").attr({"title": "Due: "+ dueDate + " (Today)"});
                }
                               
            }
            /*</editor-fold>*/  
            
            
            function daysUntil(year, month, day) {
                var now = new Date(),
                dateEnd = new Date(year, month, day), // months are zero-based
                days = (dateEnd - now) / 1000/60/60/24;   // convert milliseconds to days

                return Math.round(days);
            }

            function dialogDisplay(job){
                $("#bug_severity option").each(function(){
                    $("#Details").removeClass($(this).val());
                });
                if (job == null)
                {
                    $("#Details").addClass("normal");
                }
                else
                {
                    $("#Details").addClass(job);
                }
            }
            
            //Card creation function, adds the card to the page. Need the following Bugzilla parameters: product, component, version, bug_severity, priority. 
            //Note: Id has been added for testing purposes
            function  createCard(/**TEST ONLY**/ id,col, component,   priority, product, severity, summary, version, user, dueDate, description, status){ 
                   
                /*$.ajax({
                    url: "ajax_create_bug.php",
                    type: "POST",
                    data: {    
                        /*"whichColumn": col
                        "component": component,
                        "priority": priority,
                        "product": product,
                        "severity": severity,
                        "summary": summary,
                        "version": version
                        /*"component": component,
                    },
                    dataType: "json",
                    success: function(data, status){
                
                        if (data.error)
                        {
                            alert(data.error.message);
                        }
                        else if (!data.result)
                        {
                            alert("Something is wrong");
                        }
                        else 
                        {
                            //Card creation logic will be placed here as soon as the Bug.create/Bug.update issues have been resolved
                        }
                        
                    },
                    error: function(jqXHR, textStatus, errorThrown){
                        alert("There was an error:" + textStatus);
                    }
                });*/
                //TODO All of the follwing creation code needs to be moved up into the final else: Only want to append a new card if one is successfully stored on Bugzilla
                
                //The Bugzilla Documentation said that the create method will only return the new ID upon completion
                //var id = data.result.id[0];
                           
                var newCard = $('<div id="'+id+'" class="card "><div class="cardText">'+summary+'</div><div class="iconBar"></div></div>');
                    
                newCard.addClass("cmVoice {cMenu:\'contextMenuCard\'}, normal");
                //<div class="cardText">Existing Card</div><div class="iconBar"></div></div>   
                var newLi = $('<li></li>').append(newCard);
                                                                       
                $("#"+col.replace(/\s+/g, '')).append(newLi);
                
                    
                //TODO Move this into the success block of the AJAX call because we only want the local data to change if a new card i successfully created
                //NOTE: I realize saving the data locally and on the database violates the DRY principle however I don't want the user to have to wait for an AJAX call to complete in order to access bug info
                newCard.data({
                    "title": summary,
                    "bug_severity": severity,
                    "priority": priority,
                    "product": product,
                    "component": component,
                    "version": version,
                    "user": user,
                    "whichColumn": col,
                    "dueDate": dueDate,
                    "description": description,
                    "status": status
                        
                });
                    
                $(document).buildContextualMenu(
                {
                    menuWidth:200,
                    overflow:2,
                    menuSelector: ".menuContainer",
                    iconPath:"ico/",
                    hasImages:false,
                    fadeInTime:200,
                    fadeOutTime:100,
                    adjustLeft:0,
                    adjustTop:0,
                    opacity:.99,
                    shadow:true,
                    onContextualMenu:function(o,e){}

                });
                displayHandler(newCard);
            }

            
            // TODO: Need to find a way to store the column info on the Bugzilla server. Make a new field? Use an existing one that is otherwise rarely utilized? 
            function ajaxEditBug(col, component, id, priority, product, severity, summary, version, user, dueDate, description, status){
                /*  $.ajax({
                    url: "ajax_modify_bug.php",
                    type: "POST",
                    data: { 
                        "bug_id": id,
                        "component": component,
                        "priority": priority,
                        "product": product,
                        "severity": severity,
                        "summary": summary,
                        "version": version,
                        "status": status
                    },
                    dataType: "json",
                    success: function(data){
                
                        if (data.error)
                        {
                            alert(data.error.message);
                        }
                        else if (!data.result)
                        {
                            alert("Something is wrong");
                        }
                        else 
                        {
                            //Will eventually hold the card.data map below. Need to make the Bug.Update work first
                        }
                        
                    },
                    error: function(jqXHR, textStatus, errorThrown){
                        alert("There was an error:" + textStatus);
                    }
                });*/
                
                //TODO Move this into the success block of the AJAX call because we only want the local data to change if the database data is changed
                //NOTE: I realize saving the data locally and on the database violates the DRY principle however I don't want the user to have to wait for an AJAx call to complete in order to access bug info
                $("#"+id).data({
                    "whichColumn": col,
                    "component": component,                   
                    "product": product,
                    "priority": priority,
                    "bug_severity": severity,
                    "title": summary,
                    "version": version,
                    "user": user,
                    "dueDate": dueDate,
                    "description": description,
                    "status": status
                });
            }
            
            //An update function that stores a card position when called
            function updatePosition(column, cardId)
            {
                //Automatically updates the card's position both in local data and server data. Waiting on Bug.update Resolution
                
                /*
                 *
                 *$.ajax({
                 *  url: "ajax_modify_bug.php",
                 *  type: "POST",
                 *  data: { 
                 *       "bug_id": cardId
                 *      //TODO Need to add the below field to the Bugzilla field options
                 *      /*"whichColumn": column
                 *  },
                 *  dataType: "json",
                 *  success: function(data, status){
                 *
                 *      if (data.error)
                 *      {
                 *          alert(data.error.message);
                 *      }
                 *      else if (!data.result)
                 *      {
                 *          alert("Something is wrong");
                 *      }
                 *      else 
                 *      {
                 *          //Will eventually hold the card.data map below. Need to make the Bug.Update work first
                 *      }
                 *      
                 *  },
                 *  error: function(jqXHR, textStatus, errorThrown){
                 *      alert("There was an error:" + textStatus);
                 *  }
                 *   });
                 */
                
                $("#"+cardId).data({
                    "whichColumn": column
                });
                    
            }
               
            //A function that updates the whichColumn field of every card in a column
            /*TODO I feel like this is very inefficient, also need to figure out how to OVERLOAD!! */
            function updatePosition1(col)
            {
                $("#"+col+" .card").each(function(){
                    var cardId = $(this).attr("id");
                    updatePosition(col, cardId);
                });
            }
            
            function fileBug(component, priority, product, severity, summary, version){
               
            }
            /*$.ajax({
                url: "ajax_get_single_bug.php",
                type: "POST",
                data: { 
                   "bug_id": 4111
                   },
                dataType: "json",
                success: function(data, status){
                    //alert(data.result.bugs[0].summary);
                    var bug = data.result.bugs[0];
                    createCard("Done", bug.summary);
                }
            });*/
            
            /*$.ajax({
                url: "ajax_modify_bug.php",
                type: "POST",
                data: { 
                    "bug_id": 4111,
                    "summary": "This is a new summary"
                },
                dataType: "json",
                success: function(data, status){
                
                    if (data.error)
                    {
                        alert(data.error.message);
                    }
                    else if (!data.result)
                    {
                        alert("Something is wrong");
                    }
                    else 
                    {
                        alert("We're in");
                        var bug = data.result.bugs[0];
                    }
                },
                error: function(jqXHR, textStatus, errorThrown){
                    alert("There was an error:" + textStatus);
                }
            });*/
            
        </script>
    </head>
    <body>

        <div id="dialogInvalid" class="ui-dialog-content ui-widget-content"  title="Invalid Input" >
            <p>Must Specify the Card's Title!!!</p>
        </div>

        <div id="dialogAddEditCard" class="ui-dialog-content ui-widget-content"  title="Edit" >

            <div id="edit-tabs" class="ui-tabs ui-widget ui-widget-content ui-corner-all">
                <ul>
                    <li><a href="#Details">Details</a></li>
                    <li><a href="#Comments">Comments</a></li>
                    <li><a href="#Attachments">Attachments</a></li>
                </ul>
                <div id="Details">
                    <form>
                        <fieldset>
                            <div style="float:top; max-height: 80px;">
                                <label for="title">Title:</label>
                                <textarea  name="title" id="title" class="text ui-widget-content ui-corner-all" style="width:960px; height: 40px; max-height: 60px;"  ></textarea>
                            </div>
                            <div style="float: left;">
                                <label for="product">Product:</label>
                                <select  name="product" id="product"  class="text ui-widget-content ui-corner-all" ></select>
                                <label for="component">Component:</label>
                                <select  name="component" id="component"  class="text ui-widget-content ui-corner-all" ></select>
                                <div style="float: top">
                                    <div style="float: left;">
                                        <label for="version">version</label>
                                        <select  name="version" id="version"  class=" text ui-widget-content ui-corner-all, half">    </select>
                                    </div>
                                    <div style="float: left; margin-left: 10px;">
                                        <label for="bug_severity">Severity:</label>
                                        <select  name="bug_severity" id="bug_severity"  class=" text ui-widget-content ui-corner-all, half" ></select>
                                    </div>
                                </div>
                                <div style="float: top">
                                    <div style="float: left;">
                                        <label for="bug_status">Status:</label>
                                        <select  name="bug_status" id="bug_status"  class="text ui-widget-content ui-corner-all, half" ></select>
                                    </div>
                                    <div style="float: left; margin-left: 10px;">
                                        <label for="user">Assigned User:</label>
                                        <select  name="user" id="user"  class="text ui-widget-content ui-corner-all, half" >   
                                            <option></option>
                                            <option>User 1</option>
                                            <option>User 2</option>
                                            <option>User 3</option>
                                            <option>User 4</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="float: top">
                                    <div style="float: left;">
                                        <label for="priority">Priority:</label>
                                        <select  name="priority" id="priority"  class="text ui-widget-content ui-corner-all, half">    </select>
                                    </div>
                                    <div style="float: left; margin-left: 10px;">
                                        <label for="dueDate">Due Date:</label>
                                        <input type="text" name="dueDate" id="dueDate" class="Dates text ui-widget-content ui-corner-all, half" />
                                    </div>
                                </div>
                                <div style="float: left;">
                                    <div style="float: left;">
                                        <label for="whichColumn">Into Column:</label>
                                        <select  name="whichColumn" id="whichColumn"  class="text ui-widget-content ui-corner-all, half" >                               
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div id="rightDiv" style="float: left; margin-left: 10px; width: 665px; height: 325px;">
                                <span style="width: 75%;">
                                    <label for="description">Description:</label>
                                    <textarea  name="description" id="description" class="text ui-widget-content ui-corner-all" style="width:95%; height: 95%; max-height: 100%; max-width: 100%;"  ></textarea> 
                                </span>
                            </div>                            
                        </fieldset>
                    </form>
                </div>

                <div id="Comments">
                    <span>
                        <label for="comments">Comments</label>
                        <textarea  name="comments" id="comments"  class="text ui-widget-content ui-corner-all" style="width:95%; height: 95%; max-height: 100%; max-width: 100%;"  ></textarea>
                    </span>
                </div>
                <div id="Attachments">
                    <p>These are attachments</p>
                </div>
            </div>
        </div>   
        <div id="dialogSearch" class="ui-dialog-content ui-widget-content"  title="Advanced Search" >
            <div id="search">
                <form style="height:300px;">
                    <fieldset style="margin-top: 10px;">
                        <div class="box"style="float:top; max-height: 40px; width:830px;">
                            <label for="title" style="float:left; margin-right: 10px;">Summary:</label>
                            <textarea  name="title" id="searchSummary" class="text ui-widget-content ui-corner-all" style="float:left !important; width:auto; height: 20px; max-height: 60px; width:745px;"  ></textarea>
                        </div>
                        <div style="float: left; width:100%">
                            <div class="box">
                                <label for="product"class="searchLabel">Product:</label>
                                <select  name="product" id="searchProduct"  class="text ui-widget-content ui-corner-all" multiple="multiple"></select>
                            </div>
                            <div class="box">
                                <label for="version"class="searchLabel">Version</label>
                                <select  name="version" id="searchVersion"  class="text ui-widget-content ui-corner-all" multiple="multiple"></select>
                            </div>
                            <div class="box">
                                <label for="bug_severity"class="searchLabel">Severity:</label>
                                <select  name="bug_severity" id="searchBug_severity"  class="text ui-widget-content ui-corner-all" multiple="multiple"></select>
                            </div>
                             <div class="box">
                                <label for="priority"class="searchLabel">Priority</label>
                                <select  name="priority" id="searchPriority"  class="text ui-widget-content ui-corner-all" multiple="multiple"></select>
                            </div>
                            <div class="box">
                                <label for="bug_status"class="searchLabel">Status:</label>
                                <select  name="bug_status" id="searchBug_status"  class="text ui-widget-content ui-corner-all" multiple="multiple"></select>
                            </div>
                            <div class="box">
                                <label for="resolution"class="searchLabel">Resolution:</label>
                                <select  name="resolution" id="searchResolution"  class=" text ui-widget-content ui-corner-all" multiple="multiple"></select>
                            </div>
                        </div>                        
                    </fieldset>
                </form>
                <div id="Results" class="ui-widget">                 
                    <div id="users-contain" class="ui-widget" >
                        <h1>Bugs:</h1>
                        <table id="users" class="ui-widget ui-widget-content, tablesorter" cellspacing="0" cellpadding="4" width="100%">
                            <thead>
                                <tr class="ui-widget-header ">
                                    <th colspan="1">ID</th> 
                                    <th colspan="1">Product</th> 
                                    <th colspan="1">Version</th> 
                                    <th colspan="1">Assignee</th> 
                                    <th colspan="1">Status</th>  
                                    <th colspan="1">Resolution</th> 
                                    <th colspan="1">Summary</th> 
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <ul class="tablists cmVoice {cMenu: 'contextMenuColumn'}" id="Backlog" > 
            <li class="bigBanners">Backlog</li>      
        </ul> 
        <ul class="tablists cmVoice {cMenu: 'contextMenuColumn'}" id="Archive">
            <li class="bigBanners">Archive</li>      
        </ul>    
        <ul class="tablists cmVoice {cMenu: 'contextMenuColumn'}" id="Limbo">
            <li class="bigBanners">Limbo</li>      
        </ul> 
        <div class="toolbar">                
            <button class="btnTab">Backlog</button>
            <button class="btnTab">Archive</button>
            <button class="btnTab">Limbo</button>
            <button id="btnAddCard">Add Card</button>
            <button id="btnSearchCard">Advanced Search</button>
        </div>
        <ul id="Ready" class="column cmVoice {cMenu: 'contextMenuColumn'}">
            <li class="banners">Ready</li>                        
        </ul>
        <ul id="Development" class="dubColumn cmVoice {cMenu: 'contextMenuColumn'}">
            <li class="dubBanners">Development</li>  
            <ul id="DevelopmentDoing" class="column cmVoice {cMenu: 'contextMenuColumn'}">
                <li class="banners">Doing</li>
            </ul>
            <ul id="DevelopmentDone" class="column cmVoice {cMenu: 'contextMenuColumn'}">
                <li class="banners">Done</li>
            </ul>
        </ul>
        <ul id="Build" class="dubColumn cmVoice {cMenu: 'contextMenuColumn'}">
            <li class="dubBanners">Build</li>  
            <ul id="BuildDoing" class="column cmVoice {cMenu: 'contextMenuColumn'}">
                <li class="banners">Doing</li>
            </ul>
            <ul id="BuildDone" class="column cmVoice {cMenu: 'contextMenuColumn'}">
                <li class="banners">Done</li>
            </ul>
        </ul>
        <ul id="Test" class="column cmVoice {cMenu: 'contextMenuColumn'}">
            <li class="banners">Test</li>
        </ul>
        <ul id="ReadyforRelease" class="column cmVoice {cMenu: 'contextMenuColumn'}">
            <li class="banners">Ready for Release</li>
        </ul>
        <div class="mbmenu" id="contextMenuCard">
            <a action="editView(0)">View Card Details</a>
            <a action="editView(1)">View Card Comments</a>
            <a action="editView(2)">View Card Attachments</a>
            <a rel="separator"> </a>
            <a class="{menu:'moveCardTo'}">Move Card to</a>
            <a class="{menu:'setPriority'}">Set Priority</a>
            <a rel="separator"> </a>
            <a action="deleteCard()">Delete Card</a>
        </div>
        <div id="moveCardTo" class="mbmenu">
        </div>
        <div id="moveAllCards" class="mbmenu">
        </div>
        <div id="setPriority" class="mbmenu">
        </div>
        <div class="mbmenu" id="contextMenuColumn">            
            <a class="{menu:'moveAllCards'}">Move All Cards to</a>
            <a rel="separator"> </a>
            <a action="addCardToCol()">Add Card</a>
        </div>
        <div>
            <table id="table1">

            </table>
        </div>
    </body>
</html>

