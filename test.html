<?php
session_start();

if (!isset($_SESSION["login"]) || !isset($_SESSION["password"])) {
die(header("location: loginpage.php"));
}

session_write_close();
?>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
    <head>
        <title>Eckhardt Optics Kanban Board</title>
        <link type="text/css" href="themes/black-tie/jquery-ui-1.8.21.custom.css" rel="stylesheet" />
        <link type="text/css" href="demos.css" rel="stylesheet" />
        <link type="text/css" href="menu_black.css" rel="stylesheet" />
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <script type="text/javascript" src="jquery-1.7.2.js"></script>
        <script type="text/javascript" src="jquery.ui.core.js"></script>
        <script type="text/javascript" src="jquery.ui.widget.js"></script>
        <script type="text/javascript" src="jquery.ui.mouse.js"></script>
        <script type="text/javascript" src="jquery.ui.sortable.js"></script>
        <script type="text/javascript" src="jquery.ui.button.js"></script>
        <script type="text/javascript" src="jquery.ui.draggable.js"></script>
        <script type="text/javascript" src="jquery.ui.position.js"></script>
        <script type="text/javascript" src="jquery.ui.resizable.js"></script>
        <script type="text/javascript" src="jquery.ui.dialog.js"></script>
        <script type="text/javascript" src="jquery.ui.datepicker.js"></script>
        <script type="text/javascript" src="jquery.ui.tabs.js"></script>     
        <script type="text/javascript" src="mbMenu.js"></script>
        <script type="text/javascript" src="jquery.metadata.js"></script>
        <script type="text/javascript" src="jquery.hoverIntent.js"></script>
        <script type="text/javascript" src="jquery.json-2.3.js"></script>
        <link rel="stylesheet" media="screen" type="text/css" href="css/colorpicker.css" />
        <script type="text/javascript" src="js/colorpicker.js"></script>
        <script type="text/javascript" src="jquery.tinysort.min.js"></script>
        <link type="text/css" href="index.css" rel="stylesheet" />

        <script type="text/javascript">           
            
            var col1 = "Dev?Doing?Col1";
            var col2 = "Dev?Doing?Col2";
            var col3 = "Dev?Done?Col1";
            
            colArr = [col1, col2, col3];
            
            var columnNest = {};
            
            var tabColumns = ["Backlog", "Limbo", "Archive"];
            
            var colSortKeyMap = {};
            
            var colDivChar = "?";

            
            $(document).ready(function() {                                 
                $.ajax({
                    //Need this to be completed before other actions occur:
                    //async: false,
                    url: "ajax_POST.php",
                    type: "POST",
                    data: {
                        "method": "Bug.fields",
                        "names": ["cf_whichcolumn"],
                        "value_field": "product"                            
                    },    
                    dataType: "json",                   
                    success: function(data){                                              
                        if (data.result.faultString != null)
                        {
                            alert(data.result.faultString+'\nError Code: '+data.result.faultCode);
                        }
                        else if (!data.result)
                        {
                            alert("Something is wrong");
                        }
                        else 
                        {   
                            var colArr = data.result.fields[0].values;
                          
                            for (var i in colArr)
                            {
                                var name = colArr[i].name;
                                var columnID = colArr[i].sort_key;
                                
                                colSortKeyMap[name] = columnID;
                                
                                if (name == "---")
                                {
                                    continue;
                                }
                                else if(!$.isNumeric(i))
                                {
                                    continue;
                                }
                                else if (tabColumns.indexOf(name) >= 0 )
                                {
                                    var colHtml = '<div class="tablistsCon cmVoice {cMenu: \'contextMenuColumn\'}"><span class="bigBanners">'+name+'</span>\
                                <ul id="column_'+ colSortKeyMap[name] +'"class="tablists"></ul></div>';
                                
                                    $(".columnContainer").prepend(colHtml);
                                
                                    var buttonHtml = '<button class="btnTab">'+name+'</button>';
                                
                                    $("#btnAddCard").before(buttonHtml);
                                
                                
                                }
                                else
                                {
                                    $.extend(true, columnNest, buildColumnNestObject(name));
                                }
                               
                                
                            }
                            
                            
                            $(".columnContainer").append(buildBoard(columnNest, ""));
                              
                        }                                                                                                                                                                                                          
                    },
                    error: function(jqXHR, textStatus, errorThrown){
                        alert("(Fields)There was an error:" + textStatus);
                    }
                });
                                  
            });
            var testInput = ["Doing"];
            
            function loopInput(columnArray)
            {  
            }
            
            function buildColumnNestObject(column)
            {
                var nest = {}; 
                               
                var columnSplit = column.split(colDivChar);
                    
                if (columnSplit.length == 1)
                {
                    var col = columnSplit[0];
                    nest[col] = [];                     
                }
                else
                {                    
                    var name = columnSplit[0];
                            
                    columnSplit.splice(0,1);
                                                                                    
                    nest[name] = buildColumnNestObject(columnSplit.join(colDivChar));                                                                                                             
                }
                
                return nest;
                    
            }  
            
            function buildBoard(nest, fullName)
            {
                var html = "";
                for (var index in nest)
                {
                    if ( fullName == "")
                    {
                        var name = index;
                    }
                    else
                    {
                        name = fullName  +colDivChar+ index;
                    }
                        
                        
                    
                    if (nest[index].length != undefined && nest[index].length == 0)
                    {                        
                        html +=  "<div class=\"columnCon cmVoice {cMenu: 'contextMenuColumn'}\"><span class=\"banners\">"+index+"</span><ul id=\"column_"+colSortKeyMap[name]+"\" class=\"column\" > </ul> </div>";   
                    }
                    else
                    {
                        html += '<div  class="dubColumn cmVoice {cMenu: \'contextMenuColumn\'}"><span class="dubBanners">'+index+'</span>';
                        
                        html += buildBoard(nest[index],name);
                        
                        html += "</div>";
                        
                        
                    }
                }
                           
                return html;
                
            }
            
            
        </script>
    </head>
    <body>       

        <!--div class="columnContainer">
            <div class="toolbar">  
                <label for="quickSearchTextBox" >Quick Search</label>
                <input id="quickSearchTextBox" type="text" class="text ui-widget-content ui-corner-all"/>
                <label for="quickSearchField" >by:</label>
                <select id="quickSearchField" class="text ui-widget-content ui-corner-all"></select>           
                <button id="btnAddCard" >Add Card</button>
                <button id="btnSearchCard" >Advanced Search</button>
                <button id="btnOptions">Options</button>
                <button id="btnLogout">Log out</button>
            </div>  
        <!--div class="columnCon cmVoice {cMenu: 'contextMenuColumn'}">
            <span class="banners">Test</span>
            <ul id="Test" class="column" > </ul>            
        </div>
        <div class="columnCon cmVoice {cMenu: 'contextMenuColumn'}">
            <span class="banners">Test</span>
            <ul id="Test2" class="column" > </ul>            
        </div>
        <div id="Build" class="dubColumn cmVoice {cMenu: 'contextMenuColumn'}">
            <span class="dubBanners">Development</span>
            <div id="Build" class="dubColumn cmVoice {cMenu: 'contextMenuColumn'}">
                <span class="dubBanners">Doing</span>

                <div class="columnCon cmVoice {cMenu: 'contextMenuColumn'}">
                    <span class="banners">Col1</span>
                    <ul id="BuildDoing" class="column"></ul>
                </div>
                <div class="columnCon cmVoice {cMenu: 'contextMenuColumn'}">
                    <span class="banners">Col2</span>
                    <ul id="BuildDone" class="column"> </ul>
                </div>                    

            </div>
            <div id="Build" class="dubColumn cmVoice {cMenu: 'contextMenuColumn'}">
                <span class="dubBanners">Done</span>

                <div class="columnCon cmVoice {cMenu: 'contextMenuColumn'}">
                    <span class="banners">Col1</span>
                    <ul id="BuildDoing" class="column"></ul>
                </div>
                <div class="columnCon cmVoice {cMenu: 'contextMenuColumn'}">
                    <span class="banners">Col</span>
                    <ul id="BuildDone" class="column"> </ul>
                </div>                    

            </div>
        </div-->
        <div class="columnCon " style="" title="">
            <div class="banners">
                <span>Test</span>
            </div>
            <ul id="column_900" class="column cmVoice {cMenu: 'contextMenuColumn'} ui-sortable" cmenu="contextMenuColumn" style="-webkit-user-select: none; cursor: default; "> 
                <li>
                    <div id="139" class="card  cmVoice {cMenu:'contextMenuCard'}, normal" style="background-color: rgb(255, 68, 0); -webkit-user-select: none; cursor: default; " title="(#139)DesignBug: Implement Field Generality?" cmenu="contextMenuCard">
                        <div class="cardText">(#139) Implement Field Generality?</div>
                        <div class="iconBar">
                            <div class="prioBack" title="John Priority">
                                <div class="prioIcon" style="background-image: url(http://software-pc/PhpProject4/images/icons/icon11.png); ">

                                </div>

                            </div>

                        </div>
                        <div class="modal">
                            <div>Saving Card</div>

                        </div>

                    </div>
                </li>              
            </ul> 
        </div>
    </body>
</html>

